<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voucher Massaggio</title>

  <!-- Your font (must be in repo root) -->
  <style>
    @font-face{
      font-family:"RuntimeRegular";
      src:url("./RuntimeRegular-m2Odx.otf") format("opentype");
      font-display: swap;
    }
  </style>

  <!-- Minimal UI styling -->
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0c10; color:#e8e8e8; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 14px; }
    .card { background:#151821; border:1px solid #22283a; border-radius: 14px; padding: 14px; }
    label { display:block; font-size: 12px; opacity:.85; margin: 12px 0 6px; }
    select, button {
      width:100%; box-sizing:border-box;
      border-radius:12px; border:1px solid #2a3350;
      padding:12px; background:#0f1220; color:#e8e8e8;
      font-size:16px;
    }
    button { background:#3b82f6; border:0; font-weight:700; cursor:pointer; }
    button:active { transform: scale(.99); }
    canvas { width:100%; height:auto; border-radius:14px; border:1px solid #2a3350; background:#0f1220; margin-top:12px; }
    .muted { font-size:12px; opacity:.7; margin-top:10px; line-height:1.35; }
  </style>

  <!-- jsPDF (client-side PDF generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <label>Tipo di massaggio</label>
      <select id="massage"></select>

      <button id="download">Download PDF (Fronte + Retro)</button>

      <canvas id="canvas"></canvas>

      <div class="muted">
        File richiesti nella stessa cartella: <b>Massaggio.png</b>, <b>voucher_back.png</b>, <b>RuntimeRegular-m2Odx.otf</b>.
      </div>
    </div>
  </div>

<script>
/** === Your exact mapping (same coords) === */
const MASSAGE_POSITIONS = {
  "decontratturante": [900, 780],
  "drenante": [1020, 780],
  "linfodrenante": [940, 780],
  "relax": [1055, 780],
  "sportivo": [1035, 780],
  "anticellulite": [965, 780],
  "svedese": [1005, 780],
  "modellante": [990, 780],
  "lomi lomi": [1000, 780],
  "vacuum": [1050, 780],
  "hot stone": [1000, 780],
  "californiano": [975, 780],
  "riflessologico": [960, 780],
  "ayurvedico": [1000, 780],
};
const DEFAULT_POSITION = [960, 780];

// Other fixed positions (from your script)
const POS_EXPIRATION  = [740, 1045];
const POS_VALID_UNTIL = [745, 985];

// Adjust baseline differences between PIL and canvas
const MASSAGE_Y_OFFSET = 25; // you tuned this (20â€“30)

// Text + styles
const TEXT_VALID_UNTIL = "Valido fino a";
const SIZE_EXPIRATION = 50;
const SIZE_VALID_UNTIL = 45;
const SIZE_MASSAGE = 60;

const COLOR_WHITE = "#ffffff";
const COLOR_PINK  = "rgb(212, 158, 167)";

// Italian months
const mesi_italiani = [
  "", "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio",
  "Giugno", "Luglio", "Agosto", "Settembre",
  "Ottobre", "Novembre", "Dicembre"
];

function addMonthsKeepMonthYear(dateObj, monthsToAdd) {
  const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
  d.setMonth(d.getMonth() + monthsToAdd);
  return { m: d.getMonth() + 1, y: d.getFullYear() };
}
function expirationString() {
  const today = new Date();
  const { m, y } = addMonthsKeepMonthYear(today, 5);
  return `${mesi_italiani[m]} ${y}`;
}

// Title Case per word: "hot stone" -> "Hot Stone"
function titleCaseWords(s) {
  return (s || "")
    .split(" ")
    .filter(Boolean)
    .map(w => w.length ? w[0].toUpperCase() + w.slice(1).toLowerCase() : w)
    .join(" ");
}

// Helpers
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = () => reject(new Error(`Failed to load ${src}`));
    img.src = src;
  });
}

function imageToPngDataUrl(img, width, height) {
  // Safest for jsPDF: convert HTMLImageElement to PNG dataURL via canvas
  const c = document.createElement("canvas");
  c.width = width ?? img.naturalWidth;
  c.height = height ?? img.naturalHeight;
  const cctx = c.getContext("2d");
  cctx.drawImage(img, 0, 0, c.width, c.height);
  return c.toDataURL("image/png");
}

// DOM
const massageSelect = document.getElementById("massage");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let frontImg = null;
let backImg = null;

// Populate dropdown
function populateMassages() {
  const keys = Object.keys(MASSAGE_POSITIONS).sort((a,b)=>a.localeCompare(b));
  massageSelect.innerHTML = keys
    .map(k => `<option value="${k}">${titleCaseWords(k)}</option>`)
    .join("");
}
populateMassages();

function setCanvasToFront() {
  canvas.width = frontImg.naturalWidth;
  canvas.height = frontImg.naturalHeight;
}

function drawFront() {
  if (!frontImg) return;

  // Background
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(frontImg, 0, 0);

  // Use your font; fall back if missing
  const family = "RuntimeRegular, Arial";
  ctx.textBaseline = "alphabetic";

  // Expiration date
  ctx.fillStyle = COLOR_WHITE;
  ctx.textAlign = "left";
  ctx.font = `400 ${SIZE_EXPIRATION}px ${family}`;
  ctx.fillText(expirationString(), POS_EXPIRATION[0], POS_EXPIRATION[1]);

  // "Valido fino a"
  ctx.fillStyle = COLOR_PINK;
  ctx.font = `400 ${SIZE_VALID_UNTIL}px ${family}`;
  ctx.fillText(TEXT_VALID_UNTIL, POS_VALID_UNTIL[0], POS_VALID_UNTIL[1]);

  // Massage type (manual X positions + Y offset)
  const key = (massageSelect.value || "").trim().toLowerCase();
  const [x, y] = MASSAGE_POSITIONS[key] || DEFAULT_POSITION;
  const label = titleCaseWords(key);

  ctx.fillStyle = COLOR_WHITE;
  ctx.textAlign = "left";
  ctx.font = `700 ${SIZE_MASSAGE}px ${family}`;
  ctx.fillText(label, x, y + MASSAGE_Y_OFFSET);
}

massageSelect.addEventListener("change", drawFront);

document.getElementById("download").addEventListener("click", async () => {
  if (!frontImg || !backImg) {
    alert("Immagini non ancora caricate.");
    return;
  }

  // Ensure front is current
  drawFront();

  const { jsPDF } = window.jspdf;

  // Create PDF sized exactly like your template (1920x1080), landscape, in pixels
  const pdf = new jsPDF({
    orientation: "landscape",
    unit: "px",
    format: [canvas.width, canvas.height],
    compress: true,
  });

  // Page 1: front from existing canvas (best quality + includes text)
  const frontDataUrl = canvas.toDataURL("image/png");
  pdf.addImage(frontDataUrl, "PNG", 0, 0, canvas.width, canvas.height);

  // Page 2: back (convert to dataURL to avoid addImage compatibility issues)
  pdf.addPage([canvas.width, canvas.height], "landscape");
  const backDataUrl = imageToPngDataUrl(backImg, canvas.width, canvas.height);
  pdf.addImage(backDataUrl, "PNG", 0, 0, canvas.width, canvas.height);

  const label = titleCaseWords(massageSelect.value).replace(/\s+/g, "_");
  pdf.save(`Voucher_${label}.pdf`);
});

// Init: load images + wait for font
(async function init() {
  try {
    // Wait for font to be ready so canvas uses it immediately
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    }

    // Load both images from repo root
    [frontImg, backImg] = await Promise.all([
      loadImage("./Massaggio.png"),
      loadImage("./voucher_back.png"),
    ]);

    setCanvasToFront();
    drawFront();
  } catch (err) {
    console.error(err);
    alert(
      "Errore caricamento file. Controlla che Massaggio.png e voucher_back.png siano nella stessa cartella di index.html (repo root)."
    );
  }
})();
</script>
</body>
</html>
